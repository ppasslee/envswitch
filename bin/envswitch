#!/bin/bash
#
# 2015 Copyright SitePoint Pty Ltd.
# Author: Adam Bolte <adam.bolte@sitepoint.com>


declare -r config_dir="${HOME}/.config/envswitch"
shopt -s nullglob


function print_help()
{
	cat <<- EOF
	Usage: $(basename ${0}) OPTION

	-i      initialize (for use with eval)
	-l      list available environments
	-h      show this help message
	EOF
}


function init()
{
	cat <<- EOF
	envreset()
	{
	    local -r env_file="${config_dir}/\${ENVSWITCH_PROFILE}.conf"
	    if [ -n "\${ENVSWITCH_PROFILE}" ]
	    then
	        for line in \$(grep -v '^#' "\${env_file}")
	        do
	            unset "\${line%=*}"
	        done
	        unset ENVSWITCH_PROFILE
	        export PS1="\${ENVSWITCH_OLDPS1}"
	    fi
	}
	EOF

	for env_file in ${config_dir}/*.conf
	do
		env_file_base="$(basename ${env_file%.conf})"
		cat <<- EOF
		${env_file_base}()
		{
		    local -r env_file="${env_file}"
		    if [ -n "\${ENVSWITCH_PROFILE}" ]
		    then
		        envreset
		    fi
		    export ENVSWITCH_PROFILE='${env_file_base}'
		    for line in \$(grep -v '^#' "\${env_file}")
		    do
		        eval export \${line}
		    done
		    export ENVSWITCH_OLDPS1="\${PS1}"
		    export PS1="(${env_file_base}) \${PS1}"
		}
		EOF
	done
}

function list_environments()
{
	for env_file in ${config_dir}/*.conf
	do
		echo "$(basename ${env_file%.conf})"
	done
}


declare -i help_opt=0
declare -i init_opt=0
declare -i env_opt=0
declare -i score=0

if [ ! -d "${config_dir}" ]
then
	umask 0077
	mkdir -m 0700 "${config_dir}"
fi

while getopts "hil" option
do
	case ${option} in
		h )
			help_opt=1
			;;
		i )
			init_opt=1
			;;
		l )
			env_opt=1
			;;
		* )
			print_help
			exit 1
			;;
	esac
done

shift $((${OPTIND} - 1))

score=$((${help_opt} + ${init_opt} + ${env_opt}))
if [ ${score} -eq 0 ]
then
	echo "${0}: required option missing"
	print_help
	exit 1
elif [ ${score} -gt 1 ]
then
	echo "${0}: multiple options selected"
	print_help
	exit 1
else
	if [ "${help_opt}" -eq 1 ]
	then
		print_help
	elif [ "${init_opt}" -eq 1 ]
	then
		init
	elif [ "${env_opt}" -eq 1 ]
	then
		list_environments
	fi
fi
